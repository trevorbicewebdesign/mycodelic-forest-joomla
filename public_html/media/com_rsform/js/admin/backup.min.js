RSFormPro.Backup={forms:[],submissionsCount:{},formsPerRequest:5,submissionsPerRequest:100,progressUnit:0,progressCount:0,key:"",requestTimeOut:{Seconds:0,Milliseconds:function(){return RSFormPro.Backup.requestTimeOut.Seconds*1e3}},parseJSON:function(data){if(typeof data!="object"){var match=data.match(/{.*}/);if(match){return jQuery.parseJSON(match[0])}else{var serverError="";var matchedError=data.match(/error.*/);if(matchedError){serverError=matchedError[0].replace(/(<([^>]+)>)/gi,"").substring(0,255)}RSFormPro.Backup.showError(Joomla.JText._("RSFP_JSON_DECODING_ERROR").replace("%s",serverError));return false}}return jQuery.parseJSON(data)},showError:function(message){RSFormPro.Backup.clearError();jQuery(".progressBar").css("background","#b94a48");return jQuery(".progressWrapper").after('<div class="alert alert-error"><strong>'+Joomla.JText._("RSFP_ERROR")+"</strong> "+message+"</div>")},clearError:function(){jQuery(".alert").remove()},showStatus:function(message){jQuery(".alert").remove();return jQuery(".progressWrapper").after('<div class="alert alert-info"><strong>'+Joomla.JText._("RSFP_STATUS")+"</strong> "+message+"</div>")},parseResponse:function(data,textStatus,jqXHR){if(data.status=="error"){RSFormPro.Backup.showError(data.message)}else if(data.status=="ok"){RSFormPro.Backup.progress();if(data.key){RSFormPro.Backup.key=data.key}switch(data.step){case"forms":RSFormPro.Backup.sendRequest("storeForms",{forms:RSFormPro.Backup.forms.splice(0,RSFormPro.Backup.formsPerRequest)});RSFormPro.Backup.showStatus(Joomla.JText._("RSFP_STATUS_BACKING_UP_FORM_STRUCTURE_LEFT").replace("%d",RSFormPro.Backup.forms.length));break;case"prepare-submissions":case"next-form-submissions":case"submissions":if(jQuery("#jform_submissions1").prop("checked")?1:0){if(data.step=="prepare-submissions"){RSFormPro.Backup.grabSelectedForms()}var form;if(data.step=="next-form-submissions"||data.step=="prepare-submissions"){var nextForm=RSFormPro.Backup.forms.splice(0,1);if(nextForm.length>0){form=nextForm[0]}}else{form=data.form}if(form){RSFormPro.Backup.sendRequest("storeSubmissions",{limit:RSFormPro.Backup.submissionsPerRequest,start:data.start?data.start:0,header:data.header?data.header:0,form:form});var submissionsLeft=RSFormPro.Backup.submissionsCount[form]-parseFloat(data.start?data.start:0);if(submissionsLeft<0){submissionsLeft=0}if(submissionsLeft){RSFormPro.Backup.showStatus(Joomla.JText._("RSFP_STATUS_BACKING_UP_FORM_SUBMISSIONS_LEFT").replace("%d",form).replace("%d",submissionsLeft))}else{RSFormPro.Backup.showStatus(Joomla.JText._("RSFP_STATUS_FINISHING_UP_SUBMISSIONS_FOR_FORM").replace("%d",form))}}else{RSFormPro.Backup.sendRequest("prepareGzip")}}else{RSFormPro.Backup.sendRequest("prepareGzip")}break;case"prepare-gzip":case"compress-gzip":RSFormPro.Backup.showStatus(Joomla.JText._("RSFP_STATUS_COMPRESSING_FILES"));if(data.step=="prepare-gzip"){RSFormPro.Backup.progressUnit=100/parseFloat(data.chunks);RSFormPro.Backup.progress(true)}RSFormPro.Backup.sendRequest("compressGzip",{seek:data.seek?data.seek:0});break;case"done":RSFormPro.Backup.toggle();document.getElementById("backupKey").value=RSFormPro.Backup.key;Joomla.submitbutton("backup.download");break}}},sendRequest:function(task,data){if(!data){data={}}data["option"]="com_rsform";data["controller"]="backup";data["task"]=task;if(RSFormPro.Backup.key.length>0){data["key"]=RSFormPro.Backup.key}if(RSFormPro.Backup.requestTimeOut.Seconds!=0&&task!="start"){setTimeout(function(){RSFormPro.Backup.ajaxRequest(data)},RSFormPro.Backup.requestTimeOut.Milliseconds())}else{RSFormPro.Backup.ajaxRequest(data)}},ajaxRequest:function(data){jQuery.ajax({converters:{"text json":RSFormPro.Backup.parseJSON},type:"POST",url:"index.php?option=com_rsform",data:data,success:RSFormPro.Backup.parseResponse,dataType:"json"})},progress:function(reset){var bar=jQuery(".progressBar");var current=RSFormPro.Backup.progressCount+=RSFormPro.Backup.progressUnit;if(reset){current=0;RSFormPro.Backup.progressCount=0}if(current>100){current=100}bar.animate({width:current+"%"},{duration:"fast",step:function(now,tween){bar.html(Math.round(now)+"%")}})},grabSelectedForms:function(){RSFormPro.Backup.forms=[];jQuery(document.getElementsByName("cid[]")).each(function(index,el){if(jQuery(el).prop("checked")){RSFormPro.Backup.forms.push(jQuery(el).val())}})},start:function(){RSFormPro.Backup.toggle();RSFormPro.Backup.grabSelectedForms();var steps=0;steps++;steps+=Math.ceil(RSFormPro.Backup.forms.length/RSFormPro.Backup.formsPerRequest);steps++;if(jQuery("#jform_submissions1").prop("checked")){for(var i=0;i<RSFormPro.Backup.forms.length;i++){steps+=Math.ceil(RSFormPro.Backup.submissionsCount[RSFormPro.Backup.forms[i]]/RSFormPro.Backup.submissionsPerRequest);steps++}}RSFormPro.Backup.progressUnit=100/steps;RSFormPro.Backup.sendRequest("start",{forms:RSFormPro.Backup.forms,submissions:jQuery("#jform_submissions1").prop("checked")?1:0})},toggle:function(){var progress=jQuery(".progressWrapper");var button=jQuery("#backupButton");var forms=jQuery("#formsList");var shown=progress.is(":visible");shown?progress.fadeOut():progress.fadeIn();shown?button.show():button.hide();shown?forms.show():forms.hide();if(shown){RSFormPro.Backup.clearError();RSFormPro.Backup.forms=[];RSFormPro.Backup.progressUnit=0;RSFormPro.Backup.progressCount=0;RSFormPro.Backup.progress(true)}}};Joomla.submitbutton=function(task){if(task==="backup.start"){return RSFormPro.Backup.start()}Joomla.submitform(task)};